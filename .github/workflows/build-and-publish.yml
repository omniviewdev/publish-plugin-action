name: Build and Publish Plugin

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version'
        default: '1.23'
        type: string
      pnpm-version:
        description: 'pnpm version'
        default: '10'
        type: string
      node-version:
        description: 'Node.js version'
        default: '20'
        type: string
      plugin-id:
        description: 'Plugin ID'
        required: true
        type: string
      plugin-path:
        description: 'Root of plugin repo'
        default: '.'
        type: string
      go-entry:
        description: 'Go build entry point'
        default: './pkg'
        type: string
      ui-path:
        description: 'UI directory (empty = no UI)'
        default: './ui'
        type: string
      architectures:
        description: 'Comma-separated target architectures'
        default: 'darwin_arm64,darwin_amd64,linux_amd64,linux_arm64,windows_amd64'
        type: string
      api-url:
        description: 'Marketplace API URL'
        default: 'https://api.omniview.dev'
        type: string
      publisher-slug:
        description: 'Publisher slug'
        required: true
        type: string
      version:
        description: 'Semver version (from tag or input)'
        required: true
        type: string
    secrets:
      api-key:
        description: 'Omniview API key (omni_pk_...)'
        required: true

jobs:
  build:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - name: Setup pnpm
        if: inputs.ui-path != ''
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm-version }}

      - name: Setup Node.js
        if: inputs.ui-path != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: pnpm
          cache-dependency-path: ${{ inputs.plugin-path }}/${{ inputs.ui-path }}/pnpm-lock.yaml

      - name: Build UI
        if: inputs.ui-path != ''
        working-directory: ${{ inputs.plugin-path }}/${{ inputs.ui-path }}
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Strip version prefix
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          echo "clean=${VERSION#v}" >> "$GITHUB_OUTPUT"

      - name: Cross-compile Go binaries
        working-directory: ${{ inputs.plugin-path }}
        run: |
          IFS=',' read -ra ARCHS <<< "${{ inputs.architectures }}"
          for target in "${ARCHS[@]}"; do
            os="${target%%_*}"
            arch="${target#*_}"
            echo "Building for ${os}/${arch}..."

            ext=""
            if [ "$os" = "windows" ]; then
              ext=".exe"
            fi

            mkdir -p "dist/${target}/bin"
            GOOS="${os}" GOARCH="${arch}" CGO_ENABLED=0 \
              go build -trimpath -ldflags="-s -w" \
              -o "dist/${target}/bin/plugin${ext}" \
              ${{ inputs.go-entry }}
          done

      - name: Package artifacts
        working-directory: ${{ inputs.plugin-path }}
        run: |
          mkdir -p artifacts
          IFS=',' read -ra ARCHS <<< "${{ inputs.architectures }}"
          for target in "${ARCHS[@]}"; do
            # Copy plugin.yaml
            cp plugin.yaml "dist/${target}/"

            # Copy UI build output if it exists
            if [ -d "${{ inputs.ui-path }}/dist" ]; then
              mkdir -p "dist/${target}/assets"
              cp -r "${{ inputs.ui-path }}/dist/"* "dist/${target}/assets/"
            fi

            # Create tarball
            tar czf "artifacts/${{ inputs.plugin-id }}-${target}.tar.gz" \
              -C "dist/${target}" .
          done

          echo "Artifacts created:"
          ls -la artifacts/

      - name: Submit to Marketplace
        uses: omniviewdev/publish-plugin-action@v1
        with:
          api-key: ${{ secrets.api-key }}
          api-url: ${{ inputs.api-url }}
          publisher-slug: ${{ inputs.publisher-slug }}
          plugin-id: ${{ inputs.plugin-id }}
          version: ${{ steps.version.outputs.clean }}
          artifact-path: ${{ inputs.plugin-path }}/artifacts
          architectures: ${{ inputs.architectures }}
